{%load i18n pydate pref django_tables2%}
{%pref "FMT_DATETIME" defval="%Y-%m-%d %H:%M" returnValue=True as DateTimeFormat%}
{%pref "FMT_DATETIME_SHORT" defval="%m-%d %H:%M" returnValue=True as ShortDateTimeFormat%}
<div class="row" id="{{target.id}}_row">
   <div class="col-12 col-md-8 pnl-widget-details" id="{{target.id}}_detailPnl">
      <form action="{%url 'widget' id=target.id%}" method="GET" id="{{target.id}}_filterFrm">
         {%if target.desc%}<div class="pnl-desc">{{target.desc}}</div>{%endif%}
         <input type="hidden" name="filter" value="{{filter}}"/>
         <div class="pnl-tags input-group btn-group">
            <div class="input-group-prepend input-group-text"><i class="fas fa-filter"></i> {%trans 'actions.filter'%}</div>
            {%for t in target.tags%}
               <button type="button" class="btn btn-outline-success btn-filter" value="{{t.name}}">{{t.name}}</button>
            {%endfor%}
         </div>
         <div class="media-lobby"><canvas id="{{target.id}}_chart" class="media"></canvas></div>
         {%render_table table%}
      </form>
   </div><!-- End of #{{target.id}}_detailPnl -->
   <form class="col-12 col-md-4" method="POST" id="{{target.id}}_form" action="{%url 'widget' id=target.id%}">
      {%csrf_token%}
      <input type="hidden" name="_method" value="POST"/>
      <input type="hidden" name="FMT_DATETIME" value="{{DateTimeFormat}}"/>

      <h3>{%trans 'actions.new-record'%}</h3>

      <div class="field form-group">
         <div class="input-group field-datetime" data-target-input="nearest" id="indexTimeField">
            <input type="text" class="form-control daettimepicker-input" required="required" name="time" id="timeFld" placeholder="{%trans 'Index.time'%}" data-target="#indexTimeField" data-toggle="datetimepicker"/>
            <div class="input-group-append"><button class="btn btn-secondary btn-now" type="button" title="{%trans 'now'%}"><i class="fas fa-clock"></i></button></div>
         </div>
      </div>

      <div class="field form-group">
         <div class="input-group">
            <input type="number" class="form-control" required="required" name="value" id="valueFld" placeholder="{%trans 'Index.value'%}" value="" number="number"/>
         </div>
      </div>

      {%if target.tags%}
      <div class="field form-group">
         <label for="tagsFld">{%trans 'Index.tags'%}</label>
         <input type="hidden" name="tags" value=""/>
         <div>{%for t in target.tags%}<button type="button" class="btn btn-outline-info tagBtn" value="{{t.name}}">{{t.name}}</button>{%endfor%}</div>
      </div>
      {%endif%}

      <div class="pnl-btns">
         <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> {%trans 'actions.new-record'%}</button>
      </div>
   </form>
</div><!-- end of row -->

<script type="text/javascript"><!--
$('#{{target.id}}').bind('ready', function(){
   $(this).unbind('ready');
   //TagBtn
   $('.tagBtn').click(function(){
      if($(this).attr('clicked')){
         $(this).removeClass('btn-info').addClass('btn-outline-info').removeAttr('clicked', 'clicked');
      }else{
         $(this).removeClass('btn-outline-info').addClass('btn-info').attr('clicked', 'clicked');
      }
      $('input[name=tags]').val('');
      $('.tagBtn[clicked]').each(function(){ 
         var curr=$('input[name=tags]').val();
         if(curr.length>0)curr+=', ';
         $('input[name=tags]').val(curr+$(this).attr('value')); 
      });
   });
   $('#{{target.id}}_form').validate();
   //Handling filter
   $(this).find('.btn-filter').click(function(){
      if($(this).attr('checked')==undefined)
         $(this).attr('checked', 'checked').removeClass('btn-outline-success').addClass('btn-success');
      else
         $(this).removeAttr('checked').removeClass('btn-success').addClass('btn-outline-success');
      $('#{{target.id}}').find('input[name=filter]').val($('#{{target.id}}').find('.btn-filter[checked=checked]').map(function(){return $(this).attr('value');}).get().join());
      $('#{{target.id}}').find('#{{target.id}}_filterFrm').hide().after('<i class="fas fa-spinner fa-spin"></i>').ajaxSubmit({
         target: '#{{target.id}} > .card-body', 
         success: function(){ $('#{{target.id}}').trigger('ready');},
      });
   });
   var filter=$(this).find('input[name=filter]').val().split(',');
   for(var i=0; i<filter.length; i++){
      var f=filter[i].trim();
      if(f.length<1)continue;
      $(this).find('.btn-filter[value='+f+']').removeClass('btn-outline-success').addClass('btn-success').attr('checked', 'checked');
   }

   //Init Datetime-Picker
   $(this).find('.field-datetime').datetimepicker({'format': pydatefmt('{{DateTimeFormat}}')});

   //NowBtn
   $(this).find('.btn-now').click(function(){
      $(this).parents('.input-group').find('input:first').val(moment().format(pydatefmt('{{DateTimeFormat}}')));
   });

   //Pagination
   $(this).find('.page-link').click(function(ev){
      ev.preventDefault();
      var url='{%url "widget" id="__id__"%}'.replace('__id__', '{{target.id}}')+$(this).attr('href');
      $('#{{target.id}}').find('.card-body:first')
         .empty()
         .html('<i class="fas fa-spinner fa-spin"></i>')
         .load(url, function(){ $(this).trigger('ready'); });
   });

   //Charting Chart
   var chart=new Chart($('#{{target.id}}_chart'), {
      type: 'line',
      data: {
         labels: [{%for i in indexes reversed%}'{{i.time|pydate:ShortDateTimeFormat}}',{%endfor%}],
         datasets: [{
            data: [{%for i in indexes reversed%}{{i.value}},{%endfor%}],
         }],
         //{%if target.mimimum != target.maximum%}
         yHighlightRange: { begin: {{target.minimum}}, end: {{target.maximum}}, fill: 'rgba(0, 255, 0, 0.3)'},
         //{%endif%}
      },
      options: {
         legend: {display: false,},
         scales: {
            yAxes: [{
               ticks: {
                  beginAtZero:true
               }
            }]
         },
      },
   });
});
//--></script>
